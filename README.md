# Nzyme-Docker

Deploy Nzyme (nodes and taps) using Docker Compose.

## Details

### Configuration
The repository offers both Nzyme `node` and `tap` images. The images do not copy configuration at *build* time but are passed in during *deploy* time by using a volume. This saves time in rebuilding images and improves the developer experience when configuring Nzyme.

When mounting Nzyme configuration, we don't mount the final configuration file. Instead, we mount a *template* conf file. This template corresponds to the Nzyme configuration file, but we don't pass our config values here. Rather, the values are assigned an environment variable, which are all defined in the base project's `.env` file.

Each Nzyme image executes a `start.sh` script on entry. The script runs `envsubst` to substitute the values in the `.env` files with those in the mounted config template file.

**NOTE**: While the images are standalone and are offered <a href='https://hub.docker.com/u/randomguyoninternet'>here</a>, you will need to emulate these processes (and others). Otherwise, fork this repository and do it your own way when configuring Nzyme.

### Deployment
The current and foreseeable intent is to use Docker Compose. The main attractions towards Compose are its ease of use and ability to quickly update our services. While this may not be suitable for larger projects, it is more than adequate for our needs.

### Nzyme User
The base image (`ubuntu:22`) runs the *root* user by default. This, of course, gives us the ability to install Nzyme, along with other necessary components, but isn't great for security when running the container. Therefore, a *nzyme* user has been created and is used.

All relevant files generated by installing Nzyme have their ownership changed from *root* to *nzyme*. The exception is the contents of `/usr/share/nzyme/crypto` (read the gotchas section as to why).

## How to

1. Build Nzyme components using Docker Bake.
2. Amend values in the `.env` file. You will need to change the `TAP_SECRET_KEY` value with the secret provided by the UI.
3. Run `docker-compose up -d`.

If you update the Nzyme image or change its tag, run `docker-compose up -d` again. If you change values in the `.env` file, run `docker-compose up -d`. If you make changes to the `start.sh` script, run `docker-compose up --force-recreate -d`; otherwise, it won't pick up the latest changes.

## Gotchas

1. **Nzyme-Node, node_id:** If we recreate the Nzyme-Node container, it will auto-generate a new node_id, which will be different from that present in the database and will therefore not be able to authenticate. Therefore, we mount a static node_id into the container.
2. **Nzyme-Node, crypto keys:** Similar to the above, the keys are reset when we restart the container and (again) don't match up in the database, causing an authentication error. Therefore, we use a *volume* to manage this.

## Todo / Next
View the `Project` tab.

## Final
If you can improve anything or want to make a PR, then please do.